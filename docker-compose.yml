version: '2'
services:
  postgreshost:
    image: postgres:latest

  postgreshost17:
    image: postgres:latest

  init-postgres:
    image: postgres
    working_dir: /build
    command: sh -c "psql -h postgreshost -p 5432 -d postgres -U postgres -tc \"SELECT 1 FROM pg_database WHERE datname = 'django_waitlist_dev'\" | grep -q 1 || psql -h postgreshost -p 5432 -U postgres -c \"CREATE DATABASE django_waitlist_dev\""
    depends_on:
      - postgreshost

  init-postgres17:
    image: postgres
    working_dir: /build
    command: sh -c "psql -h postgreshost17 -p 5432 -d postgres -U postgres -tc \"SELECT 1 FROM pg_database WHERE datname = 'django_waitlist_dev'\" | grep -q 1 || psql -h postgreshost17 -p 5432 -U postgres -c \"CREATE DATABASE django_waitlist_dev\""
    depends_on:
      - postgreshost17

  web:
    build:
      context: .
      dockerfile: docker/Dockerfile.django19
    command: uwsgi --ini uwsgi.ini
    volumes:
      - .:/app
    ports:
      - "3000:3000"
    links:
      - postgreshost

  web17:
    build:
      context: .
      dockerfile: docker/Dockerfile.django17
    command: uwsgi --ini uwsgi.ini
    volumes:
      - .:/app
    ports:
      - "3000:3000"
    links:
      - postgreshost17:postgreshost

  tcell_web:
    build:
      context: .
      dockerfile: docker/Dockerfile.django19
    command: sh -c "pip install --upgrade tcell_agent && tcell_agent run uwsgi --ini uwsgi.ini"
    volumes:
      - .:/app
    ports:
      - "3000:3000"
    links:
      - postgreshost
    security_opt:
      - seccomp:unconfined

  tcell_local_web:
    build:
      context: .
      dockerfile: docker/Dockerfile.django19
    command: sh -c "pip install --upgrade /tcellagent_src && tcell_agent run uwsgi --ini uwsgi.ini"
    volumes:
      - ../pythonagent-tcell:/tcellagent_src
      - .:/app
    ports:
      - "3000:3000"
    links:
      - postgreshost
    security_opt:
      - seccomp:unconfined

  tcell_local_web_sqlite:
    build:
      context: .
      dockerfile: docker/Dockerfile.django19
    command: sh -c "pip install --upgrade /tcellagent_src && tcell_agent run uwsgi --ini uwsgi.ini"
    volumes:
      - ../pythonagent-tcell:/tcellagent_src
      - .:/app
      - ./docker/settings.py.sqlite:/app/django_waitlist/settings.py
    ports:
      - "3000:3000"
    security_opt:
      - seccomp:unconfined

  tcell_web17:
    build:
      context: .
      dockerfile: docker/Dockerfile.django17
    command: sh -c "pip install --upgrade tcell_agent && tcell_agent run uwsgi --ini uwsgi.ini"
    volumes:
      - .:/app
    ports:
      - "3000:3000"
    links:
      - postgreshost17:postgreshost
    security_opt:
      - seccomp:unconfined

  tcell_web18:
    build:
      context: .
      dockerfile: docker/Dockerfile.django18
    command: sh -c "pip install --upgrade tcell_agent && tcell_agent run uwsgi --ini uwsgi.ini"
    volumes:
      - .:/app
    ports:
      - "3000:3000"
    links:
      - postgreshost
    security_opt:
      - seccomp:unconfined

  tcell_web110:
    build:
      context: .
      dockerfile: docker/Dockerfile.django110
    command: sh -c "pip install --upgrade tcell_agent && tcell_agent run uwsgi --ini uwsgi.ini"
    volumes:
      - .:/app
      - ./docker/settings.py.django110:/app/django_waitlist/settings.py
    ports:
      - "3000:3000"
    links:
      - postgreshost
    security_opt:
      - seccomp:unconfined

  tcell_web110_old_settings:
    build:
      context: .
      dockerfile: docker/Dockerfile.django110
    command: sh -c "pip install --upgrade tcell_agent && tcell_agent run uwsgi --ini uwsgi.ini"
    volumes:
      - .:/app
    ports:
      - "3000:3000"
    links:
      - postgreshost
    security_opt:
      - seccomp:unconfined

  tcell_local_web17:
    build:
      context: .
      dockerfile: docker/Dockerfile.django17
    command: sh -c "pip install --upgrade /tcellagent_src && tcell_agent run uwsgi --ini uwsgi.ini"
    volumes:
      - ../pythonagent-tcell:/tcellagent_src
      - .:/app
    ports:
      - "3000:3000"
    links:
      - postgreshost17:postgreshost
    security_opt:
      - seccomp:unconfined

  tcell_local_web18:
    build:
      context: .
      dockerfile: docker/Dockerfile.django18
    command: sh -c "pip install --upgrade /tcellagent_src && tcell_agent run uwsgi --ini uwsgi.ini"
    volumes:
      - ../pythonagent-tcell:/tcellagent_src
      - .:/app
    ports:
      - "3000:3000"
    links:
      - postgreshost
    security_opt:
      - seccomp:unconfined

  tcell_local_web110:
    build:
      context: .
      dockerfile: docker/Dockerfile.django110
    command: sh -c "pip install --upgrade /tcellagent_src && tcell_agent run uwsgi --ini uwsgi.ini"
    volumes:
      - ../pythonagent-tcell:/tcellagent_src
      - .:/app
      - ./docker/settings.py.django110:/app/django_waitlist/settings.py
    ports:
      - "3000:3000"
    links:
      - postgreshost
    security_opt:
      - seccomp:unconfined

  tcell_local_web110_old_settings:
    build:
      context: .
      dockerfile: docker/Dockerfile.django110
    command: sh -c "pip install --upgrade /tcellagent_src && tcell_agent run uwsgi --ini uwsgi.ini"
    volumes:
      - ../pythonagent-tcell:/tcellagent_src
      - .:/app
    ports:
      - "3000:3000"
    links:
      - postgreshost
    security_opt:
      - seccomp:unconfined

  tcell_local_web17_newrelic:
    build:
      context: .
      dockerfile: docker/Dockerfile.django17
    command: sh -c "pip install --upgrade /tcellagent_src && newrelic-admin run-program tcell_agent run uwsgi --ini uwsgi.ini"
    volumes:
      - ../pythonagent-tcell:/tcellagent_src
      - .:/app
    ports:
      - "3000:3000"
    links:
      - postgreshost17:postgreshost
    environment:
      - NEW_RELIC_CONFIG_FILE=newrelic.ini
    security_opt:
      - seccomp:unconfined
